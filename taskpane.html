<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ModelForge</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#f5f5f5;--fg:#18181b;--card:#fff;--muted:#71717a;--border:#e5e5e5;
--blue:#0485f7;--green:#10b981;--red:#ef4444;--amber:#f59e0b;--purple:#a855f7;
--radius:10px;--radius-lg:14px;--radius-pill:20px;
}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--fg);font-size:13px;line-height:1.5;overflow-x:hidden}
/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
.header-left{display:flex;align-items:center;gap:8px}
.logo{width:26px;height:26px;border-radius:7px;background:var(--blue);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:11px}
.header-title{font-weight:700;font-size:14px;letter-spacing:-0.02em}
.status-pill{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:var(--radius-pill);font-size:10px;font-weight:600;background:rgba(16,185,129,.1);color:var(--green)}
.status-dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
/* Quick Start Cards */
.section{padding:16px}
.section-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--muted);margin-bottom:10px}
.quick-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.quick-card{background:var(--card);border-radius:var(--radius);padding:12px;cursor:pointer;border:2px solid transparent;transition:all .15s}
.quick-card:hover{border-color:var(--blue);transform:translateY(-1px)}
.quick-card.active{border-color:var(--blue);background:rgba(4,133,247,.04)}
.quick-card .qc-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;margin-bottom:6px}
.quick-card .qc-title{font-weight:700;font-size:12px;margin-bottom:2px}
.quick-card .qc-sub{font-size:10px;color:var(--muted);line-height:1.3}
.qc-lbo .qc-icon{background:rgba(4,133,247,.1);color:var(--blue)}
.qc-dcf .qc-icon{background:rgba(16,185,129,.1);color:var(--green)}
.qc-ma .qc-icon{background:rgba(168,85,247,.1);color:var(--purple)}
.qc-var .qc-icon{background:rgba(245,158,11,.1);color:var(--amber)}
.qc-comps .qc-icon{background:rgba(239,68,68,.1);color:var(--red)}
.qc-stmt .qc-icon{background:rgba(113,113,122,.1);color:var(--muted)}
/* Build Form */
.build-form{background:var(--card);border-radius:var(--radius-lg);margin:0 16px;padding:16px;border:1px solid var(--border)}
.form-row{margin-bottom:12px}
.form-row:last-child{margin-bottom:0}
.form-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--muted);margin-bottom:4px;display:block}
.form-input,.form-select,.form-textarea{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-family:inherit;background:var(--bg);color:var(--fg);outline:none;transition:border-color .15s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--blue);background:var(--card)}
.form-textarea{resize:vertical;min-height:72px;line-height:1.5}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.form-row-2col{display:grid;grid-template-columns:1fr 1fr;gap:8px}
/* Primary CTA */
.btn-build{width:100%;padding:12px 16px;border-radius:var(--radius-pill);border:none;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .15s;margin-top:4px}
.btn-build.primary{background:var(--blue);color:#fff}
.btn-build.primary:hover{opacity:.92;transform:translateY(-1px)}
.btn-build:disabled{opacity:.5;cursor:not-allowed;transform:none}
/* Live Build Progress */
.build-progress{background:var(--card);border-radius:var(--radius-lg);margin:16px;padding:16px;border:1px solid var(--border);display:none}
.build-progress.active{display:block}
.bp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.bp-title{font-weight:700;font-size:13px;display:flex;align-items:center;gap:6px}
.bp-title .spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
.bp-pct{font-size:12px;font-weight:700;color:var(--blue)}
.bp-bar-track{height:4px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:14px}
.bp-bar-fill{height:100%;background:var(--blue);border-radius:4px;transition:width .3s ease;width:0%}
.bp-steps{list-style:none}
.bp-step{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px}
.bp-step .step-icon{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}
.bp-step.pending .step-icon{background:var(--bg);color:var(--muted)}
.bp-step.active .step-icon{background:rgba(4,133,247,.15);color:var(--blue);animation:pulse 1s infinite}
.bp-step.done .step-icon{background:rgba(16,185,129,.15);color:var(--green)}
.bp-step.active .step-label{font-weight:600;color:var(--fg)}
.bp-step.done .step-label{color:var(--muted)}
.bp-step.pending .step-label{color:var(--muted)}
.bp-cell-count{font-size:11px;color:var(--muted);text-align:center;margin-top:10px}
/* Result Card */
.result-card{background:var(--card);border-radius:var(--radius-lg);margin:0 16px 16px;padding:16px;border:1px solid rgba(16,185,129,.2);display:none}
.result-card.active{display:block}
.rc-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.rc-check{width:28px;height:28px;border-radius:50%;background:rgba(16,185,129,.12);color:var(--green);display:flex;align-items:center;justify-content:center;font-size:14px}
.rc-title{font-weight:700;font-size:14px}
.rc-meta{font-size:11px;color:var(--muted)}
.rc-sheets{list-style:none;margin:10px 0}
.rc-sheets li{display:flex;align-items:center;gap:6px;padding:4px 0;font-size:12px}
.rc-sheets li::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0}
.rc-sheets .sheet-rows{color:var(--muted);font-size:11px;margin-left:auto}
.btn-secondary{width:100%;padding:10px;border-radius:var(--radius-pill);border:1px solid var(--border);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;background:var(--card);color:var(--fg);display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s;margin-top:8px}
.btn-secondary:hover{background:var(--bg)}
/* Training Context */
.training-strip{margin:0 16px;padding:10px 12px;background:var(--card);border-radius:var(--radius);display:flex;align-items:center;gap:8px;border:1px solid var(--border)}
.training-strip .ts-badge{padding:3px 8px;border-radius:var(--radius-pill);font-size:10px;font-weight:600;white-space:nowrap}
.training-strip .ts-text{font-size:11px;color:var(--muted);flex:1;min-width:0}
.ts-ok .ts-badge{background:rgba(16,185,129,.1);color:var(--green)}
.ts-warn .ts-badge{background:rgba(245,158,11,.1);color:var(--amber)}
/* Loading / Error */
#loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:12px}
.spinner-lg{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#loading-text{font-size:12px;color:var(--muted)}
#app{display:none}
#error{display:none;padding:24px;text-align:center;color:var(--red);font-size:12px}
.gap-12{height:12px}
.gap-16{height:16px}
</style>
</head>
<body>
<div id="loading"><div class="spinner-lg"></div><div id="loading-text">Connecting to Excel...</div></div>
<div id="error"><p>Failed to initialize. Sideload the manifest.xml in Excel first.</p></div>
<div id="app">

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">MF</div>
    <span class="header-title">ModelForge</span>
  </div>
  <div class="status-pill" id="statusPill">
    <div class="status-dot"></div>
    <span id="statusText">Connected</span>
  </div>
</div>

<!-- Quick Start -->
<div class="section">
  <div class="section-title">Build a Model</div>
  <div class="quick-grid">
    <div class="quick-card qc-lbo" onclick="selectQuick('LBO')">
      <div class="qc-icon">&#x1F4C8;</div>
      <div class="qc-title">LBO</div>
      <div class="qc-sub">6 sheets &middot; IRR, MOIC, debt waterfall</div>
    </div>
    <div class="quick-card qc-dcf" onclick="selectQuick('DCF')">
      <div class="qc-icon">&#x1F4B0;</div>
      <div class="qc-title">DCF</div>
      <div class="qc-sub">4 sheets &middot; WACC, terminal value</div>
    </div>
    <div class="quick-card qc-ma" onclick="selectQuick('M&A')">
      <div class="qc-icon">&#x1F91D;</div>
      <div class="qc-title">M&amp;A</div>
      <div class="qc-sub">6 sheets &middot; accretion/dilution</div>
    </div>
    <div class="quick-card qc-var" onclick="selectQuick('Variance')">
      <div class="qc-icon">&#x1F4CA;</div>
      <div class="qc-title">Variance</div>
      <div class="qc-sub">3 sheets &middot; budget vs actual</div>
    </div>
    <div class="quick-card qc-comps" onclick="selectQuick('Comps')">
      <div class="qc-icon">&#x1F4CB;</div>
      <div class="qc-title">Comps</div>
      <div class="qc-sub">5 sheets &middot; trading multiples</div>
    </div>
    <div class="quick-card qc-stmt" onclick="selectQuick('3-Statement')">
      <div class="qc-icon">&#x1F4D1;</div>
      <div class="qc-title">3-Stmt</div>
      <div class="qc-sub">6 sheets &middot; IS, BS, CF linked</div>
    </div>
  </div>
</div>

<!-- Build Form -->
<div class="build-form" id="buildForm">
  <div class="form-row form-row-2col">
    <div>
      <label class="form-label">Model Type</label>
      <select class="form-select" id="fModelType">
        <option value="LBO">LBO</option>
        <option value="DCF">DCF</option>
        <option value="M&A">M&amp;A</option>
        <option value="Variance">Variance</option>
        <option value="Comps">Comps</option>
        <option value="3-Statement">3-Statement</option>
      </select>
    </div>
    <div>
      <label class="form-label">Industry</label>
      <input class="form-input" id="fIndustry" placeholder="e.g. SaaS, Healthcare">
    </div>
  </div>
  <div class="form-row">
    <label class="form-label">Company Name</label>
    <input class="form-input" id="fCompany" placeholder="e.g. Acme Corp">
  </div>
  <div class="form-row">
    <label class="form-label">Describe Your Model</label>
    <textarea class="form-textarea" id="fPrompt" placeholder="e.g. $50M EBITDA software company, 12x entry, 5-year hold, targeting 25% IRR"></textarea>
  </div>
  <div class="form-row">
    <button class="btn-build primary" id="btnBuild" onclick="buildModel()">
      <span id="btnBuildText">Build in Excel</span>
    </button>
  </div>
</div>

<div class="gap-12"></div>

<!-- Training context strip -->
<div class="training-strip ts-warn" id="trainingStrip">
  <div class="ts-badge" id="tsBadge">Loading...</div>
  <div class="ts-text" id="tsText">Checking platform training data</div>
</div>

<div class="gap-16"></div>

<!-- Live Build Progress -->
<div class="build-progress" id="buildProgress">
  <div class="bp-header">
    <div class="bp-title"><div class="spinner"></div> <span id="bpTitle">Generating model...</span></div>
    <div class="bp-pct" id="bpPct">0%</div>
  </div>
  <div class="bp-bar-track"><div class="bp-bar-fill" id="bpBar"></div></div>
  <ul class="bp-steps" id="bpSteps"></ul>
  <div class="bp-cell-count" id="bpCells"></div>
</div>

<!-- Result Card -->
<div class="result-card" id="resultCard">
  <div class="rc-header">
    <div class="rc-check">&#x2713;</div>
    <div>
      <div class="rc-title" id="rcTitle">Model Complete</div>
      <div class="rc-meta" id="rcMeta"></div>
    </div>
  </div>
  <ul class="rc-sheets" id="rcSheets"></ul>
  <button class="btn-secondary" onclick="resetForm()">Build Another Model</button>
</div>

</div><!-- /app -->

<script>
/* ─── Configuration ─── */
var API_BASE = "https://lfnhmmwjsjpbqoesnflk.supabase.co/functions/v1/make-server-f3f66941";
var ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxmbmhtbXdqc2pwYnFvZXNuZmxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk0OTk5MzYsImV4cCI6MjA1NTA3NTkzNn0.jM4GV1pFy-8V9bVJz4hj-KjsNhHRzEOaVCqzfyOrOsM";
var AUTH = {"Content-Type":"application/json","Authorization":"Bearer "+ANON_KEY};
var generated = null, cellData = null;

/* ─── Prompt templates ─── */
var TEMPLATES = {
  "LBO":"Create an LBO model. Entry at {mult}x EBITDA, 5-year hold. Include Sources & Uses, operating projections, debt waterfall with TLA/TLB/Mezz tranches, cash flow sweep, IRR and MOIC sensitivity tables.",
  "DCF":"Create a DCF valuation model. 5-year projection with revenue growth tapering, EBITDA margins, unlevered FCF waterfall, WACC-based discounting, Gordon Growth terminal value, and a WACC vs terminal growth sensitivity table.",
  "M&A":"Create an M&A merger model. Include standalone valuations for acquirer and target, transaction assumptions with cash/stock mix, pro forma income statement, accretion/dilution analysis, and synergy schedule.",
  "Variance":"Create a budget vs actual variance analysis. Include line-by-line variance summary with dollar and percentage variances, flagging (critical/warning/on-track), executive summary with top unfavorable items, and trend analysis.",
  "Comps":"Create a comparable company analysis. Include peer selection with 6-8 public companies, financial summary, valuation multiples (EV/Revenue, EV/EBITDA, P/E), implied valuation range, and football field chart data.",
  "3-Statement":"Create a 3-statement financial model. Include a linked Income Statement, Balance Sheet, and Cash Flow Statement with supporting schedules for working capital, depreciation, and debt."
};
var DEFAULT_MULTS = {"LBO":"10","DCF":"","M&A":"","Variance":"","Comps":"","3-Statement":""};

/* ─── Quick Start ─── */
function selectQuick(type) {
  document.querySelectorAll('.quick-card').forEach(function(c){c.classList.remove('active')});
  var cls = {'LBO':'qc-lbo','DCF':'qc-dcf','M&A':'qc-ma','Variance':'qc-var','Comps':'qc-comps','3-Statement':'qc-stmt'};
  var el = document.querySelector('.'+cls[type]);
  if(el) el.classList.add('active');
  document.getElementById('fModelType').value = type;
  var tpl = TEMPLATES[type]||'';
  if(DEFAULT_MULTS[type]) tpl = tpl.replace('{mult}',DEFAULT_MULTS[type]);
  else tpl = tpl.replace('{mult}','10');
  document.getElementById('fPrompt').value = tpl;
  document.getElementById('fPrompt').focus();
  document.getElementById('buildForm').scrollIntoView({behavior:'smooth',block:'center'});
}

/* ─── Build Model (Generate + Live Populate) ─── */
function buildModel() {
  var prompt = document.getElementById('fPrompt').value.trim();
  var modelType = document.getElementById('fModelType').value;
  var company = document.getElementById('fCompany').value.trim();
  var industry = document.getElementById('fIndustry').value.trim();
  if(!prompt){alert('Describe the model you want to build.');return;}

  var btn = document.getElementById('btnBuild');
  btn.disabled = true;
  document.getElementById('btnBuildText').textContent = 'Generating...';

  // Show progress
  var prog = document.getElementById('buildProgress');
  prog.classList.add('active');
  document.getElementById('resultCard').classList.remove('active');
  setProgress(0, 'Sending to GPT...');
  setSteps([
    {id:'gen',label:'Generating model with GPT',status:'active'},
    {id:'sheets',label:'Creating sheets in Excel',status:'pending'},
    {id:'cells',label:'Writing cells & formulas',status:'pending'},
    {id:'format',label:'Formatting & finishing',status:'pending'}
  ]);
  prog.scrollIntoView({behavior:'smooth',block:'center'});

  // Simulate generation progress while waiting
  var genTimer = setInterval(function(){
    var bar = document.getElementById('bpBar');
    var w = parseFloat(bar.style.width)||0;
    if(w<25) bar.style.width = (w+0.5)+'%';
    document.getElementById('bpPct').textContent = Math.round(parseFloat(bar.style.width))+'%';
  },200);

  fetch(API_BASE+"/ai/generate",{method:"POST",headers:AUTH,body:JSON.stringify({
    prompt:prompt,modelType:modelType,companyName:company||undefined,industry:industry||undefined
  })})
  .then(function(r){return r.json()})
  .then(function(data){
    clearInterval(genTimer);
    if(data.error) throw new Error(data.error);
    generated = data.model;
    cellData = data.cellData;
    stepDone('gen');
    setProgress(30,'Model generated! Building in Excel...');
    populateLive();
  })
  .catch(function(err){
    clearInterval(genTimer);
    console.error('Generation error:',err);
    alert('Generation failed: '+err.message);
    btn.disabled = false;
    document.getElementById('btnBuildText').textContent = 'Build in Excel';
    prog.classList.remove('active');
  });
}

/* ─── Live Populate Workbook ─── */
function populateLive() {
  if(!generated||!cellData||!cellData.length){
    showResult();return;
  }
  if(typeof Excel==='undefined'){
    alert('Excel API not available. Open this inside Excel.');
    showResult();return;
  }

  stepActive('sheets');
  setProgress(35,'Creating sheets...');

  // Group cells by sheet
  var sheetGroups = {};
  cellData.forEach(function(c){
    if(!sheetGroups[c.sheet]) sheetGroups[c.sheet]=[];
    sheetGroups[c.sheet].push(c);
  });
  var sheetNames = Object.keys(sheetGroups);
  var totalCells = cellData.length;
  var writtenCells = 0;
  var currentSheetIdx = 0;

  function processNextSheet() {
    if(currentSheetIdx >= sheetNames.length){
      // All sheets done - format
      stepDone('cells');
      stepActive('format');
      setProgress(90,'Formatting...');
      finishFormatting();
      return;
    }

    var sheetName = sheetNames[currentSheetIdx];
    var cells = sheetGroups[sheetName];
    var pctBase = 35 + (currentSheetIdx/sheetNames.length)*50;
    setProgress(pctBase, 'Writing: '+sheetName+'...');
    document.getElementById('bpCells').textContent = writtenCells+' / '+totalCells+' cells';

    // Update step label
    updateStepLabel('sheets','Creating: '+sheetName);

    Excel.run(function(ctx){
      var wb = ctx.workbook;
      var ws;
      if(currentSheetIdx===0){
        ws = wb.worksheets.getActiveWorksheet();
        ws.name = sheetName;
      } else {
        ws = wb.worksheets.add(sheetName);
      }

      // Write cells in batches
      cells.forEach(function(cell){
        var r = ws.getRange(cell.cell);
        if(cell.value!=null) r.values=[[cell.value]];
        if(cell.bold) r.format.font.bold=true;
        if(cell.format==='currency') r.numberFormat=[['$#,##0']];
        else if(cell.format==='percent') r.numberFormat=[['0.0%']];
        else if(cell.format==='multiple') r.numberFormat=[['0.0"x"']];
      });

      // Activate this sheet so user can see it being built
      ws.activate();

      return ctx.sync();
    })
    .then(function(){
      writtenCells += cells.length;
      document.getElementById('bpCells').textContent = writtenCells+' / '+totalCells+' cells';
      if(currentSheetIdx===0) stepDone('sheets');
      if(currentSheetIdx===0) stepActive('cells');
      currentSheetIdx++;
      // Small delay so user can SEE each sheet being created
      setTimeout(processNextSheet, 300);
    })
    .catch(function(err){
      console.error('Sheet write error ('+sheetName+'):',err);
      currentSheetIdx++;
      setTimeout(processNextSheet, 100);
    });
  }

  processNextSheet();
}

function finishFormatting() {
  if(typeof Excel==='undefined'){showResult();return;}
  Excel.run(function(ctx){
    var sheets = ctx.workbook.worksheets;
    sheets.load('items/name');
    return ctx.sync().then(function(){
      // Freeze panes on each sheet
      sheets.items.forEach(function(ws){
        try{ws.freezePanes.freezeRows(1);}catch(e){}
      });
      // Go back to first sheet
      if(sheets.items.length>0) sheets.items[0].activate();
      return ctx.sync();
    });
  })
  .then(function(){
    stepDone('format');
    setProgress(100,'Complete!');
    setTimeout(showResult, 400);
  })
  .catch(function(){
    stepDone('format');
    setProgress(100,'Complete!');
    setTimeout(showResult, 400);
  });

  // Sync model to platform
  if(generated && API_BASE){
    fetch(API_BASE+"/models",{method:"POST",headers:AUTH,body:JSON.stringify({
      id:generated.id||('ai-gen-'+Date.now()),name:generated.name,type:generated.type,
      deal:'AI Generated',assumptions:generated.assumptions||{},status:'In Progress',
      assignee:'AI',assigneeName:'AI Engine'
    })}).catch(function(){});
  }
}

function showResult() {
  document.getElementById('buildProgress').classList.remove('active');
  var rc = document.getElementById('resultCard');
  rc.classList.add('active');
  document.getElementById('rcTitle').textContent = generated.name||'Model Complete';
  var sheets = generated.sheets||[];
  document.getElementById('rcMeta').textContent = sheets.length+' sheets \u00b7 '+(cellData?cellData.length:0)+' cells \u00b7 '+(generated.metadata?generated.metadata.patternsUsed:0)+' training patterns';
  var sl = document.getElementById('rcSheets');
  sl.innerHTML = sheets.map(function(s){
    return '<li>'+s.name+'<span class="sheet-rows">'+(s.rows?s.rows.length:0)+' rows</span></li>';
  }).join('');
  rc.scrollIntoView({behavior:'smooth',block:'center'});
  document.getElementById('btnBuild').disabled=false;
  document.getElementById('btnBuildText').textContent='Build in Excel';
}

function resetForm() {
  document.getElementById('resultCard').classList.remove('active');
  document.querySelectorAll('.quick-card').forEach(function(c){c.classList.remove('active')});
  document.getElementById('fPrompt').value='';
  document.getElementById('fCompany').value='';
  document.getElementById('fIndustry').value='';
  generated=null; cellData=null;
  window.scrollTo({top:0,behavior:'smooth'});
}

/* ─── Progress Helpers ─── */
function setProgress(pct,label) {
  document.getElementById('bpBar').style.width=pct+'%';
  document.getElementById('bpPct').textContent=Math.round(pct)+'%';
  if(label) document.getElementById('bpTitle').innerHTML=(pct<100?'<div class="spinner"></div> ':'\u2713 ')+label;
}
function setSteps(steps) {
  var ul = document.getElementById('bpSteps');
  ul.innerHTML = steps.map(function(s){
    var icon = s.status==='done'?'\u2713':(s.status==='active'?'\u25CF':'\u25CB');
    return '<li class="bp-step '+s.status+'" id="step-'+s.id+'"><div class="step-icon">'+icon+'</div><span class="step-label">'+s.label+'</span></li>';
  }).join('');
}
function stepDone(id){
  var el=document.getElementById('step-'+id);
  if(!el)return;
  el.className='bp-step done';
  el.querySelector('.step-icon').textContent='\u2713';
}
function stepActive(id){
  var el=document.getElementById('step-'+id);
  if(!el)return;
  el.className='bp-step active';
  el.querySelector('.step-icon').textContent='\u25CF';
}
function updateStepLabel(id,text){
  var el=document.getElementById('step-'+id);
  if(!el)return;
  el.querySelector('.step-label').textContent=text;
}

/* ─── Training Status ─── */
function loadTraining() {
  if(!API_BASE)return;
  fetch(API_BASE+"/ai/patterns",{headers:AUTH})
  .then(function(r){return r.json()})
  .then(function(data){
    var count=data.count||0;
    var strip=document.getElementById('trainingStrip');
    var badge=document.getElementById('tsBadge');
    var text=document.getElementById('tsText');
    if(count>0){
      strip.className='training-strip ts-ok';
      badge.textContent=count+' pattern'+(count>1?'s':'');
      text.textContent='AI uses your uploaded Excel patterns as context';
    } else {
      strip.className='training-strip ts-warn';
      badge.textContent='No patterns';
      text.textContent='Upload models on the web platform to train AI';
    }
  })
  .catch(function(){
    document.getElementById('tsBadge').textContent='Offline';
    document.getElementById('tsText').textContent='Could not reach platform';
    document.getElementById('trainingStrip').className='training-strip ts-warn';
  });
}

/* ─── Connection Check ─── */
function checkConnection() {
  if(!API_BASE){
    document.getElementById('statusText').textContent='No API';
    document.getElementById('statusPill').style.color='var(--amber)';
    return;
  }
  fetch(API_BASE+"/health",{headers:AUTH})
  .then(function(r){return r.json()})
  .then(function(d){
    if(d.status==='ok'){
      document.getElementById('statusText').textContent='Connected';
      document.getElementById('statusPill').style.color='var(--green)';
      document.getElementById('statusPill').style.background='rgba(16,185,129,.1)';
    }
  })
  .catch(function(){
    document.getElementById('statusText').textContent='Offline';
    document.getElementById('statusPill').style.color='var(--red)';
    document.getElementById('statusPill').style.background='rgba(239,68,68,.1)';
    document.querySelector('.status-dot').style.animation='none';
  });
}

/* ─── Office.js Init ─── */
Office.onReady(function(info){
  console.log('[MF] Office.onReady, host='+info.host);
  document.getElementById('loading').style.display='none';
  document.getElementById('app').style.display='block';
  checkConnection();
  loadTraining();
});

// Fallback for browser testing
setTimeout(function(){
  if(document.getElementById('loading').style.display!=='none'){
    document.getElementById('loading').style.display='none';
    document.getElementById('app').style.display='block';
    document.getElementById('statusText').textContent='Browser Mode';
    document.getElementById('statusPill').style.color='var(--amber)';
    document.getElementById('statusPill').style.background='rgba(245,158,11,.1)';
    checkConnection();
    loadTraining();
  }
},4000);
</script>
</body>
</html>
